"""
Alembic Migration Script Template
"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '7295a9595bf2'
down_revision = '001'
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    # Create enum type (check if exists first)
    connection = op.get_bind()
    result = connection.execute(sa.text("SELECT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'datasetstatus')"))
    type_exists = result.scalar()
    
    if not type_exists:
        op.execute("CREATE TYPE datasetstatus AS ENUM ('empty', 'incomplete', 'valid')")
    
    # Add status column as nullable first
    op.add_column('datasets', sa.Column('status', sa.Enum('empty', 'incomplete', 'valid', name='datasetstatus'), nullable=True))
    
    # Set default value for existing rows (assume valid if they have storage_path)
    op.execute("UPDATE datasets SET status = 'valid' WHERE storage_path IS NOT NULL AND storage_path != ''")
    op.execute("UPDATE datasets SET status = 'empty' WHERE storage_path IS NULL OR storage_path = ''")
    
    # Now make it NOT NULL
    op.alter_column('datasets', 'status', nullable=False)
    
    op.add_column('datasets', sa.Column('yaml_path', sa.String(length=512), nullable=True))
    op.alter_column('datasets', 'storage_path',
               existing_type=sa.VARCHAR(length=512),
               nullable=True)
    op.drop_constraint(op.f('detection_results_detection_job_id_fkey'), 'detection_results', type_='foreignkey')
    op.create_foreign_key(None, 'detection_results', 'detection_jobs', ['detection_job_id'], ['id'])
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(None, 'detection_results', type_='foreignkey')
    op.create_foreign_key(op.f('detection_results_detection_job_id_fkey'), 'detection_results', 'detection_jobs', ['detection_job_id'], ['id'], ondelete='CASCADE')
    op.alter_column('datasets', 'storage_path',
               existing_type=sa.VARCHAR(length=512),
               nullable=False)
    op.drop_column('datasets', 'yaml_path')
    op.drop_column('datasets', 'status')
    
    # Drop enum type
    op.execute("DROP TYPE datasetstatus")
    # ### end Alembic commands ###
